-- CREATE DATABASE
CREATE DATABASE IF NOT EXISTS HOSPITALMANAGEMENT;
USE HOSPITALMANAGEMENT;

-- =========================
-- PATIENTS TABLE
-- =========================
CREATE TABLE PATIENTS (
    PATIENT_ID INT PRIMARY KEY,
    NAME VARCHAR(100),
    DOB DATE,
    GENDER VARCHAR(10),
    PHONE_NUMBER VARCHAR(20),
    EMAIL VARCHAR(100),
    ADDRESS VARCHAR(255),
    REGISTRATION_DATE DATE,
    BLOOD_GROUP VARCHAR(5),
    EMERGENCY_CONTACT VARCHAR(20)
);

INSERT INTO PATIENTS VALUES
(1, 'AMIT SHARMA', '1990-05-10', 'MALE', '9876543210', 'AMIT@GMAIL.COM', 'DELHI', '2023-02-10', 'O+', '9876543211'),
(2, 'PRIYA SINGH', '1992-08-15', 'FEMALE', '9876501234', 'PRIYA@GMAIL.COM', 'MUMBAI', '2023-04-12', 'A+', '9876501235'),
(3, 'ROHAN MEHTA', '1985-01-20', 'MALE', NULL, 'ROHAN@GMAIL.COM', 'PUNE', '2022-11-05', 'B+', '9876501236'),
(4, 'SNEHA KAPOOR', '1998-03-22', 'FEMALE', '9123456780', 'SNEHA@GMAIL.COM', 'DELHI', '2024-01-15', 'AB+', '9123456781'),
(5, 'NEW PATIENT', '2000-05-01', 'MALE', '9999999999', 'NEW@GMAIL.COM', 'JAIPUR', CURDATE(), 'O-', '9999999990'),
(6, 'RAHUL JAIN', '2001-07-15', 'MALE', '9988771122', 'RAHUL@GMAIL.COM', 'CHENNAI', CURDATE(), 'B+', '9876543211');

-- =========================
-- DOCTORS TABLE
-- =========================
CREATE TABLE DOCTORS (
    DOCTOR_ID INT PRIMARY KEY,
    NAME VARCHAR(100),
    SPECIALIZATION VARCHAR(100),
    PHONE_NUMBER VARCHAR(20),
    EMAIL VARCHAR(100),
    AVAILABLE_DAYS VARCHAR(50),
    CONSULTATION_FEE INT,
    EXPERIENCE INT,
    DEGREE VARCHAR(50),
    IS_AVAILABLE BOOLEAN DEFAULT TRUE
);

INSERT INTO DOCTORS VALUES
(1, 'DR. VERMA', 'CARDIOLOGY', '9988776655', 'VERMA@GMAIL.COM', 'MON-FRI', 1500, 18, 'MBBS, MD', TRUE),
(2, 'DR. RITU', 'NEUROLOGY', '8877665544', 'RITU@GMAIL.COM', 'TUE-SAT', 1200, 10, 'MBBS, DM', TRUE),
(3, 'DR. KARAN', 'DERMATOLOGY', NULL, 'KARAN@GMAIL.COM', 'MON-WED', 900, 4, 'MBBS, MD', TRUE);

-- =========================
-- DEPARTMENTS TABLE
-- =========================
CREATE TABLE DEPARTMENTS (
    DEPARTMENT_ID INT PRIMARY KEY,
    DEPARTMENT_NAME VARCHAR(100)
);

INSERT INTO DEPARTMENTS VALUES
(1, 'CARDIOLOGY'),
(2, 'NEUROLOGY'),
(3, 'DERMATOLOGY'),
(4, 'ORTHOPEDICS'),
(5, 'PEDIATRICS');

-- =========================
-- DOCTOR_DEPARTMENT (MAPPING)
-- =========================
CREATE TABLE DOCTOR_DEPARTMENT (
    DOCTOR_ID INT,
    DEPARTMENT_ID INT,
    FOREIGN KEY (DOCTOR_ID) REFERENCES DOCTORS(DOCTOR_ID),
    FOREIGN KEY (DEPARTMENT_ID) REFERENCES DEPARTMENTS(DEPARTMENT_ID)
);

INSERT INTO DOCTOR_DEPARTMENT VALUES
(1, 1),
(2, 2),
(2, 5),
(3, 3);

-- =========================
-- APPOINTMENTS TABLE
-- =========================
CREATE TABLE APPOINTMENTS (
    APPOINTMENT_ID INT PRIMARY KEY,
    PATIENT_ID INT,
    DOCTOR_ID INT,
    APPOINTMENT_DATE DATE,
    STATUS VARCHAR(20),
    FOREIGN KEY (PATIENT_ID) REFERENCES PATIENTS(PATIENT_ID),
    FOREIGN KEY (DOCTOR_ID) REFERENCES DOCTORS(DOCTOR_ID)
);

INSERT INTO APPOINTMENTS VALUES
(1, 1, 1, '2024-02-10', 'COMPLETED'),
(2, 2, 2, '2024-03-05', 'SCHEDULED'),
(3, 3, 3, '2023-12-15', 'CANCELLED'),
(4, 4, 1, '2024-01-20', 'COMPLETED'),
(5, 5, 2, '2024-01-25', 'SCHEDULED'),
(6, 6, 3, '2024-01-28', 'COMPLETED');

-- =========================
-- MEDICAL RECORDS TABLE
-- =========================
CREATE TABLE MEDICAL_RECORDS (
    RECORD_ID INT PRIMARY KEY,
    PATIENT_ID INT,
    DOCTOR_ID INT,
    DIAGNOSIS VARCHAR(255),
    PRESCRIPTION VARCHAR(255),
    TREATMENT_DATE DATE,
    FOREIGN KEY (PATIENT_ID) REFERENCES PATIENTS(PATIENT_ID),
    FOREIGN KEY (DOCTOR_ID) REFERENCES DOCTORS(DOCTOR_ID)
);

INSERT INTO MEDICAL_RECORDS VALUES
(1, 1, 1, 'HEART PAIN', 'MEDICINE A', '2024-02-10'),
(2, 1, 1, 'FOLLOW UP', 'MEDICINE B', '2024-03-01'),
(3, 2, 2, 'MIGRAINE', 'MEDICINE C', '2024-03-05'),
(4, 4, 1, 'CHEST INFECTION', 'MEDICINE D', '2024-01-20'),
(5, 5, 2, 'COLD & FEVER', 'MEDICINE E', '2024-01-25'),
(6, 6, 3, 'SKIN RASH', 'MEDICINE F', '2024-01-28');

-- =========================
-- BILLING TABLE
-- =========================
CREATE TABLE BILLING (
    INVOICE_ID INT PRIMARY KEY,
    PATIENT_ID INT,
    APPOINTMENT_ID INT,
    AMOUNT INT,
    PAYMENT_STATUS VARCHAR(20),
    PAYMENT_DATE DATE,
    FOREIGN KEY (PATIENT_ID) REFERENCES PATIENTS(PATIENT_ID),
    FOREIGN KEY (APPOINTMENT_ID) REFERENCES APPOINTMENTS(APPOINTMENT_ID)
);

INSERT INTO BILLING VALUES
(1, 1, 1, 2500, 'PAID', '2024-02-11'),
(2, 2, 2, 1200, 'PENDING', NULL),
(3, 4, 4, 1500, 'PAID', '2024-01-21'),
(4, 5, 5, 1000, 'PAID', '2024-01-26'),
(5, 6, 6, 900, 'PAID', '2024-01-29');

-- =========================
-- UPDATES AND DELETES
-- =========================
UPDATE PATIENTS 
SET ADDRESS='RAMPUR'
WHERE PATIENT_ID=2;

DELETE FROM APPOINTMENTS
WHERE STATUS='CANCELLED'
AND APPOINTMENT_DATE < DATE_SUB(CURDATE(), INTERVAL 6 MONTH);

-- =========================
-- SAMPLE QUERIES (UNCHANGED, UPPERCASE)
-- =========================
SELECT * FROM PATIENTS
WHERE REGISTRATION_DATE >= DATE_SUB(CURDATE(), INTERVAL 1 YEAR);

SELECT PATIENT_ID, SUM(AMOUNT) AS TOTAL_SPENT
FROM BILLING
GROUP BY PATIENT_ID
ORDER BY TOTAL_SPENT DESC
LIMIT 5;

SELECT * FROM DOCTORS 
WHERE CONSULTATION_FEE > 1000;

SELECT * FROM APPOINTMENTS
WHERE STATUS='SCHEDULED' AND DOCTOR_ID=3;

SELECT * FROM DOCTORS
WHERE SPECIALIZATION='CARDIOLOGY' OR SPECIALIZATION='NEUROLOGY';

SELECT * FROM PATIENTS
WHERE PATIENT_ID NOT IN (
    SELECT PATIENT_ID FROM APPOINTMENTS
    WHERE APPOINTMENT_DATE >= DATE_SUB(CURDATE(), INTERVAL 1 YEAR)
);

SELECT * FROM DOCTORS ORDER BY SPECIALIZATION;

SELECT DOCTOR_ID, COUNT(*) AS TOTAL_PATIENTS
FROM APPOINTMENTS
GROUP BY DOCTOR_ID;

SELECT D.DEPARTMENT_NAME, SUM(B.AMOUNT) AS TOTAL_REVENUE
FROM BILLING B
JOIN APPOINTMENTS A ON B.APPOINTMENT_ID = A.APPOINTMENT_ID
JOIN DOCTOR_DEPARTMENT DD ON A.DOCTOR_ID = DD.DOCTOR_ID
JOIN DEPARTMENTS D ON DD.DEPARTMENT_ID = D.DEPARTMENT_ID
GROUP BY D.DEPARTMENT_NAME;

SELECT SUM(AMOUNT) AS TOTAL_REVENUE FROM BILLING;

SELECT DOCTOR_ID, COUNT(*) AS TOTAL_VISITS
FROM APPOINTMENTS
GROUP BY DOCTOR_ID
ORDER BY TOTAL_VISITS DESC
LIMIT 1;

SELECT AVG(CONSULTATION_FEE) AS AVG_FEE FROM DOCTORS;

SELECT D.NAME, D.SPECIALIZATION, DEPT.DEPARTMENT_NAME
FROM DOCTORS D
INNER JOIN DOCTOR_DEPARTMENT DD ON D.DOCTOR_ID = DD.DOCTOR_ID
INNER JOIN DEPARTMENTS DEPT ON DD.DEPARTMENT_ID = DEPT.DEPARTMENT_ID;

SELECT P.NAME, A.APPOINTMENT_DATE
FROM PATIENTS P
LEFT JOIN APPOINTMENTS A ON P.PATIENT_ID = A.PATIENT_ID AND A.STATUS='COMPLETED';

SELECT A.APPOINTMENT_ID, B.INVOICE_ID
FROM APPOINTMENTS A
RIGHT JOIN BILLING B ON A.APPOINTMENT_ID = B.APPOINTMENT_ID
WHERE B.INVOICE_ID IS NULL;

SELECT P.PATIENT_ID, P.NAME, A.APPOINTMENT_ID
FROM PATIENTS P
LEFT JOIN APPOINTMENTS A ON P.PATIENT_ID = A.PATIENT_ID
UNION
SELECT P.PATIENT_ID, P.NAME, A.APPOINTMENT_ID
FROM PATIENTS P
RIGHT JOIN APPOINTMENTS A ON P.PATIENT_ID = A.PATIENT_ID;

SELECT DOCTOR_ID
FROM APPOINTMENTS
GROUP BY DOCTOR_ID
HAVING COUNT(*) > 50;

SELECT PATIENT_ID, SUM(AMOUNT) AS TOTAL
FROM BILLING
GROUP BY PATIENT_ID
ORDER BY TOTAL DESC
LIMIT 1;

SELECT *
FROM APPOINTMENTS
WHERE DOCTOR_ID IN (
    SELECT DOCTOR_ID FROM DOCTORS WHERE SPECIALIZATION='DERMATOLOGY'
);

SELECT MONTH(APPOINTMENT_DATE) AS MONTH, COUNT(*) AS VISITS
FROM APPOINTMENTS
GROUP BY MONTH(APPOINTMENT_DATE);

SELECT DATE_FORMAT(TREATMENT_DATE, '%d-%m-%Y') AS FORMATTED_DATE
FROM MEDICAL_RECORDS;

SELECT UPPER(NAME) FROM PATIENTS;

SELECT TRIM(NAME) FROM DOCTORS;

SELECT COALESCE(PHONE_NUMBER, 'NOT AVAILABLE') FROM PATIENTS;

SELECT DOCTOR_ID, COUNT(*) AS TOTAL,
RANK() OVER (ORDER BY COUNT(*) DESC) AS RANKING
FROM APPOINTMENTS
GROUP BY DOCTOR_ID;

SELECT MONTH(PAYMENT_DATE) AS MONTH,
SUM(AMOUNT) AS REVENUE,
SUM(SUM(AMOUNT)) OVER (ORDER BY MONTH(PAYMENT_DATE)) AS CUMULATIVE_REVENUE
FROM BILLING
WHERE PAYMENT_STATUS='PAID'
GROUP BY MONTH(PAYMENT_DATE);

SELECT APPOINTMENT_DATE,
COUNT(*) OVER (ORDER BY APPOINTMENT_DATE ROWS UNBOUNDED PRECEDING) AS RUNNING_TOTAL
FROM APPOINTMENTS;

SELECT PATIENT_ID,
CASE
    WHEN COUNT(*) > 5 THEN 'HIGH'
    WHEN COUNT(*) BETWEEN 3 AND 5 THEN 'MEDIUM'
    ELSE 'LOW'
END AS PATIENT_RISK_LEVEL
FROM MEDICAL_RECORDS
GROUP BY PATIENT_ID;

SELECT DOCTOR_ID, NAME, EXPERIENCE,
CASE
    WHEN EXPERIENCE > 15 THEN 'SENIOR'
    WHEN EXPERIENCE BETWEEN 5 AND 15 THEN 'MID-LEVEL'
    ELSE 'JUNIOR'
END AS DOCTOR_CATEGORY
FROM DOCTORS;
